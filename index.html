<!DOCTYPE html>
<html>
<head>
  <script>
    let lastTitle = '';
    let lastDescription = '';
  </script>

  <!--====== Required meta tags ======-->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!--====== Title ======-->
  <title>Beacon MED NU IT</title>

  <!--====== Favicon Icon ======-->
  <link rel="shortcut icon" href="html/images/logo_beacon.png" type="image/png">

  <!--====== Bootstrap css ======-->
  <link rel="stylesheet" href="html/css/bootstrap.min.css">

  <!--====== Line Icons css ======-->
  <link rel="stylesheet" href="html/css/LineIcons.css">

  <!--====== Magnific Popup css ======-->
  <link rel="stylesheet" href="html/css/magnific-popup.css">

  <!--====== Default css ======-->
  <link rel="stylesheet" href="html/css/default.css">

  <!--====== Style css ======-->
  <link rel="stylesheet" href="html/css/style.css">
</head>

<body>

<!-- Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>By using this website, you agree to the terms and conditions stated...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="acceptTermsBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div id="container">
    <div id="messages"></div>
  </div>
  <a href="#" class="back-to-top"><i class="lni-chevron-up"></i></a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<script src="html/js/vendor/modernizr-3.6.0.min.js"></script>
<script src="html/js/vendor/jquery-1.12.4.min.js"></script>
<script src="html/js/bootstrap.min.js"></script>
<script src="html/js/jquery.magnific-popup.min.js"></script>
<script src="html/js/parallax.min.js"></script>
<script src="html/js/waypoints.min.js"></script>
<script src="html/js/jquery.counterup.min.js"></script>
<script src="html/js/jquery.appear.min.js"></script>
<script src="html/js/scrolling-nav.js"></script>
<script src="html/js/jquery.easing.min.js"></script>
<script src="html/js/main.js"></script>

<script>
    $(document).ready(function() {
      $('#termsModal').modal('show');
      $('#acceptTermsBtn').on('click', function() {
        $('#termsModal').modal('hide');
      });
    });

    const socket = new WebSocket('wss://beaconcpe.onrender.com');
    socket.onopen = (event) => {
      console.log('WebSocket connection opened:');
    };

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'beacon') {
            const bannerImage = document.getElementById('bannerImage');
            const bannerTitle = document.getElementById('bannerTitle');
            const bannerDescription = document.getElementById('bannerDescription');
            const bannerOcc = document.getElementById('bannerOcc');
            if (!originalImageUrl) {
                originalImageUrl = bannerImage.src;
                originalTitle = bannerTitle.textContent;
                originalDes = bannerDescription.textContent;
                originalOcc = bannerOcc.textContent;
            }

            bannerImage.src = data.pictureUrl;
            bannerImage.width = 350;
            bannerImage.height = 527;
            bannerTitle.textContent = data.displayName;
            bannerDescription.textContent = data.statusMessage;
            bannerOcc.textContent = data.occupplace;

            messageDisplay = 'สวัสดีคุณ :'+data.displayName;
            const messageDisplayText = `${messageDisplay}`;    
            generateAndPlay();

            setTimeout(() => {
                bannerImage.src = originalImageUrl;
                bannerImage.width = 320;
                bannerImage.height = 270;
                bannerTitle.textContent = originalTitle;
                bannerDescription.textContent = originalDes;
                bannerOcc.textContent = originalOcc;
            }, 10000);
        }
    };

    const apiKey = "xsSNKRNausLPYBeHFg8twecnQ9gh9jT8";
    const baseUrl = "https://api.aiforthai.in.th/vaja9/synth_audiovisual";

    const generateAudio = async (text, speaker, phraseBreak, audiovisual) => {
      const requestOptions = {
        method: "POST",
        headers: {
          "Apikey": apiKey,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          input_text: text,
          speaker: speaker,
          phrase_break: phraseBreak,
          audiovisual: audiovisual,
        }),
      };

      const response = await fetch(baseUrl, requestOptions);
      const responseData = await response.json();
      return responseData;
    };

    const downloadAudio = async (wavUrl) => {
      const requestOptions = {
        method: "GET",
        headers: {
          "Apikey": apiKey,
        },
      };

      const response = await fetch(wavUrl, requestOptions);
      const audioData = await response.arrayBuffer();
      return audioData;
    };

    const generateAndPlay = async () => {
      try {
        const text = messageDisplay;
        const speaker = 1;
        const phraseBreak = 0;
        const audiovisual = 1;

        const audioResponse = await generateAudio(text, speaker, phraseBreak, audiovisual);
        const wavUrl = audioResponse.wav_url;

        const audioData = await downloadAudio(wavUrl);

        const audioContext = new AudioContext();
        const audioBuffer = await audioContext.decodeAudioData(audioData);
        const audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;
        audioSource.connect(audioContext.destination);
        audioSource.start();
        console.log(wavUrl);
      } catch (error) {
        console.error("Error:", error);
      }
    };

    const textInput = document.getElementById("textInput");
    const generateAndPlayButton = document.getElementById("generateAndPlay");
    generateAndPlayButton.addEventListener("click", generateAndPlay);
</script>  

</body>
</html>
